# üèóÔ∏è ARQUITECTURA COMPLETA DEL SISTEMA AGM BROKER

## üìã √çNDICE
1. [Visi√≥n General](#visi√≥n-general)
2. [Proyectos y Tecnolog√≠as](#proyectos-y-tecnolog√≠as)
3. [Flujo de Comunicaci√≥n](#flujo-de-comunicaci√≥n)
4. [Arquitectura Detallada](#arquitectura-detallada)
5. [Dominios y URLs](#dominios-y-urls)
6. [Sistemas de Base de Datos](#sistemas-de-base-de-datos)

---

## üéØ VISI√ìN GENERAL

Sistema completo de trading broker que integra MetaTrader 5 con funcionalidades de:
- **Gesti√≥n de Cuentas MT5** (real-time)
- **Copy Trading** (maestros y seguidores)
- **PAMM** (fondos de gesti√≥n)
- **Sistema de Afiliados**
- **KYC/Verificaci√≥n de Usuarios**
- **CRM Administrativo**

---

## üì¶ PROYECTOS Y TECNOLOG√çAS

### 1Ô∏è‚É£ **FRONTEND - Aplicaci√≥n Cliente** 
üìÇ **Ruta:** `/home/rdpuser/Desktop/broker_agm`

**Stack Tecnol√≥gico:**
- React 19 + Vite
- Supabase (auth y datos)
- Firebase (auth secundario)
- React Router DOM
- Axios para HTTP
- Recharts para gr√°ficos
- i18next (internacionalizaci√≥n ES/EN)

**Prop√≥sito:**
- Dashboard principal para traders/inversores
- Gesti√≥n de cuentas MT5
- Copy Trading (seguir maestros)
- PAMM (invertir en fondos)
- Sistema de afiliados
- KYC/Verificaci√≥n
- Wallet/Transacciones

**Dominio P√∫blico:**
- En desarrollo: `http://localhost:5173`
- Producci√≥n: (por configurar con dominio)

**APIs que consume:**
```
VITE_API_BASE_URL=https://apekapital.com:444
VITE_TRADING_API_URL=https://apekapital.com:444
VITE_BROKER_API_URL=https://apekapital.com:444
```

---

### 2Ô∏è‚É£ **MAIN BACKEND - MT5 Manager API** 
üìÇ **Ruta:** `/home/rdpuser/Desktop/metatrader-api-v2`

**Stack Tecnol√≥gico:**
- Python 3.8+ + FastAPI
- MT5Manager API (nativo de MetaQuotes)
- Supabase (base de datos principal)
- Redis (cach√© y colas)
- Uvicorn (servidor ASGI)

**Prop√≥sito:**
- **Conexi√≥n directa con servidor MT5**
- Gesti√≥n de cuentas broker (crear, modificar, eliminar)
- Balance operations (dep√≥sitos, retiros, bonos)
- Sync worker (sincronizaci√≥n autom√°tica MT5 ‚Üí Supabase)
- Endpoints optimizados para dashboard
- **Proxy hacia Copy-PAMM** (endpoints internos)

**Dominio P√∫blico:**
```
https://apekapital.com:444
```

**Endpoints Principales:**
```
GET  /api/health
POST /api/v1/auth/login
GET  /api/v1/accounts/{account_login}
GET  /api/v1/accounts/{account_login}/dashboard
GET  /api/v1/accounts/{account_login}/metrics
POST /api/v1/broker/accounts/create
POST /api/v1/broker/accounts/deposit
POST /api/v1/broker/accounts/withdraw
POST /api/v1/broker/accounts/bonus

# Proxy Copy-PAMM (frontend ‚Üí main backend ‚Üí copy-pamm)
GET  /api/v1/copy/masters
POST /api/v1/copy/follow
POST /api/v1/copy/unfollow
GET  /api/v1/pamm/funds
POST /api/v1/pamm/join
```

**Arquitectura Interna:**
```
/src/
  /application/api/          # Routers FastAPI
    - accounts.py            # Gesti√≥n cuentas
    - trading.py             # Trading operations
    - broker/accounts.py     # Broker management
    - proxy_copypamm.py      # üî¥ PROXY a copy-pamm
    - supabase_accounts.py   # Optimized queries
  /domain/                   # Modelos de negocio
  /infrastructure/
    - mt5_manager_service.py # MT5 Manager integration
    - supabase_client.py     # Supabase operations
```

---

### 3Ô∏è‚É£ **BACKEND SECUNDARIO - Copy-PAMM Logic** 
üìÇ **Ruta:** `/home/rdpuser/Desktop/copy-pamm`

**Stack Tecnol√≥gico:**
- Node.js + Express
- Supabase (base de datos)
- Redis + Bull/BullMQ (colas de trabajo)
- Pino (logging)

**Prop√≥sito:**
- **L√≥gica de negocio de Copy Trading**
- Detecci√≥n de trades de maestros
- Replicaci√≥n autom√°tica a seguidores
- Gesti√≥n de relaciones maestro-seguidor
- Sistema PAMM (fondos de inversi√≥n)
- Worker system (procesos en background)

**Dominio:**
```
INTERNO: http://localhost:8080
(NO tiene dominio p√∫blico, solo accesible desde main backend)
```

**Endpoints:**
```
GET  /api/health
GET  /api/v1/copy/masters
POST /api/v1/copy/follow
POST /api/v1/copy/unfollow
GET  /api/v1/copy/subscriptions
GET  /api/v1/copy/followers
GET  /api/v1/copy/portfolio
POST /api/v1/copy/configure-master
GET  /api/v1/pamm/funds
POST /api/v1/pamm/join
POST /api/v1/pamm/leave
POST /api/v1/email/send
```

**Workers/Background Jobs:**
- `ReplicationDetector` - Detecta trades nuevos de maestros
- `WorkerManager` - Gestiona workers paralelos
- Colas Redis para procesamiento as√≠ncrono

---

### 4Ô∏è‚É£ **MICROSERVICIO - MT5 Trade Service** 
üìÇ **Ruta:** `/home/rdpuser/Desktop/mt5-trade-service`

**Stack Tecnol√≥gico:**
- C# .NET 8.0
- MT5Manager API (nativo MetaQuotes)
- ASP.NET Core Minimal API

**Prop√≥sito:**
- **Ejecuci√≥n directa de trades en MT5**
- Usado exclusivamente por Copy-PAMM backend
- Abre/cierra posiciones en cuentas follower
- Comunicaci√≥n ultrarr√°pida con MT5

**Dominio:**
```
INTERNO: http://localhost:5555
(Solo accesible desde copy-pamm backend)
```

**Endpoints:**
```
GET  /health
POST /execute-trade       # Ejecutar trade
POST /close-position      # Cerrar posici√≥n
```

**Flujo de Uso:**
```
Copy-PAMM detecta trade maestro 
  ‚Üí Llama a MT5 Trade Service 
  ‚Üí Ejecuta en cuenta follower
```

---

### 5Ô∏è‚É£ **CRM BROKER - Panel Administrativo** 
üìÇ **Ruta:** `/home/rdpuser/Desktop/crm-agm-broker`

**Stack Tecnol√≥gico:**
- React 19 + TypeScript + Vite
- Clerk (autenticaci√≥n admin)
- Supabase (base de datos)
- Radix UI + Tailwind CSS
- TanStack Query + Router
- Zustand (state management)

**Prop√≥sito:**
- **Panel administrativo del broker**
- Gesti√≥n de usuarios/clientes
- Aprobaci√≥n de KYC
- Gesti√≥n de cuentas MT5
- Balance management (dep√≥sitos/retiros/bonos)
- Sistema de tareas internas
- Reportes y anal√≠ticas
- Gesti√≥n de PAMM/Copy Trading

**Dominio:**
```
En desarrollo: http://localhost:5173
(Separado del frontend cliente)
```

**Integraci√≥n MT5:**
```typescript
// Se conecta a: https://apekapital.com:444
const MT5_BASE_URL = 'https://apekapital.com:444'
```

---

## üîÑ FLUJO DE COMUNICACI√ìN

### **FLUJO 1: Usuario consulta balance/dashboard**
```
Frontend (broker_agm)
  ‚Üì GET https://apekapital.com:444/api/v1/accounts/{login}/dashboard
Main Backend (metatrader-api-v2)
  ‚Üì Query optimizada a Supabase + Cache Redis
Supabase Database
  ‚Üì Datos ya sincronizados por MT5SyncWorker
Response ‚Üê Frontend
```

### **FLUJO 2: Copy Trading - Seguir a un maestro**
```
Frontend (broker_agm)
  ‚Üì POST https://apekapital.com:444/api/v1/copy/follow
Main Backend (metatrader-api-v2)
  ‚Üì proxy_copypamm.py redirige ‚Üí
Copy-PAMM Backend (localhost:8080)
  ‚Üì Guarda relaci√≥n en Supabase
  ‚Üì ReplicationDetector empieza a monitorear
Response ‚Üê Main Backend ‚Üê Frontend
```

### **FLUJO 3: Copy Trading - Replicaci√≥n autom√°tica**
```
Maestro opera en MT5
  ‚Üì
MT5SyncWorker detecta nuevo trade
  ‚Üì Actualiza Supabase
Copy-PAMM ReplicationDetector
  ‚Üì Detecta trade nuevo (polling cada 5s)
  ‚Üì Calcula volumen proporcional
  ‚Üì POST http://localhost:5555/execute-trade
MT5 Trade Service (C#)
  ‚Üì Ejecuta en cuenta follower via MT5Manager
MT5 Server
  ‚úì Trade replicado en follower
```

### **FLUJO 4: CRM crea cuenta MT5**
```
CRM (crm-agm-broker)
  ‚Üì POST https://apekapital.com:444/api/v1/broker/accounts/create
Main Backend (metatrader-api-v2)
  ‚Üì mt5_manager_service.py
  ‚Üì UserAdd() en MT5Manager API
MT5 Server
  ‚Üì Cuenta creada
  ‚Üì Guarda en Supabase
Response con login/password ‚Üê CRM
```

### **FLUJO 5: Sincronizaci√≥n autom√°tica MT5**
```
MT5SyncWorker (background process)
  ‚Üì Cada 30-60 segundos
  ‚Üì UserAccountRequest() para balance/equity
  ‚Üì DealRequestByLogins() para trades
MT5 Server
  ‚Üì
Actualiza Supabase (broker_accounts, trading_operations)
  ‚Üì
Frontend/CRM consultan datos ya sincronizados
```

---

## üåê DOMINIOS Y URLS

### **Producci√≥n:**
```
Frontend Cliente:        (por configurar dominio)
Main Backend MT5:        https://apekapital.com:444
Copy-PAMM Backend:       localhost:8080 (interno)
MT5 Trade Service:       localhost:5555 (interno)
CRM Broker:              (por configurar dominio)
```

### **Configuraci√≥n de red:**
```
VPS ‚Üí Main Backend (p√∫blico en puerto 444 HTTPS)
VPS ‚Üí Copy-PAMM (interno localhost:8080)
VPS ‚Üí MT5 Trade Service (interno localhost:5555)
VPS ‚Üí MT5 Server (conexi√≥n Manager API)
```

---

## üóÑÔ∏è SISTEMAS DE BASE DE DATOS

### **Supabase (Principal)**
```
URL: https://ukngiipxpprielwdfuvln.supabase.co

Tablas principales:
- profiles                 # Usuarios del sistema
- broker_accounts          # Cuentas MT5
- account_balance_history  # Historial de balances
- account_metrics          # M√©tricas calculadas
- trading_operations       # Trades/deals
- copy_relationships       # Relaciones maestro-seguidor
- pamm_funds              # Fondos PAMM
- pamm_investments        # Inversiones en fondos
- user_referrals          # Sistema de afiliados
- kyc_documents           # Verificaci√≥n KYC
- wallet_transactions     # Transacciones wallet
```

### **Redis (Cache y Colas)**
```
Usado por:
- Main Backend: Cache de consultas optimizadas
- Copy-PAMM: Colas de trabajo (Bull/BullMQ)

Colas:
- replication_queue       # Trades a replicar
- detection_queue         # Detecci√≥n de trades
```

### **Firebase (Auth secundario)**
```
Proyecto: ape-prop
Usado por: Frontend (broker_agm)
Rol: Autenticaci√≥n de usuarios (alternativo a Supabase Auth)
```

---

## üîë DATOS CR√çTICOS

### **Variables de entorno cr√≠ticas:**

**Main Backend (.env):**
```bash
# MT5 Manager
MT5_MANAGER_SERVER_HOST=your-server.com
MT5_MANAGER_SERVER_PORT=443
MT5_MANAGER_LOGIN=1000001
MT5_MANAGER_PASSWORD=***

# Supabase
SUPABASE_URL=https://ukngiipxpprielwdfuvln.supabase.co
SUPABASE_SERVICE_KEY=***

# Copy-PAMM
COPYPAMM_API_URL=http://localhost:8080/api/v1

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
```

**Copy-PAMM (.env):**
```bash
# Supabase
SUPABASE_URL=https://ukngiipxpprielwdfuvln.supabase.co
SUPABASE_KEY=***

# MT5 Trade Service
MT5_TRADE_SERVICE_URL=http://localhost:5555

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
```

**MT5 Trade Service (appsettings.Production.json):**
```json
{
  "MT5": {
    "Server": "your-server:443",
    "Login": 1008,
    "Password": "***"
  },
  "Service": {
    "Port": 5555,
    "Host": "localhost"
  }
}
```

---

## üìä ARQUITECTURA VISUAL

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        INTERNET                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                             ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ FRONTEND‚îÇ                   ‚îÇ   CRM   ‚îÇ
    ‚îÇ (React) ‚îÇ                   ‚îÇ (React) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                             ‚îÇ
         ‚îÇ HTTPS                       ‚îÇ HTTPS
         ‚îÇ :444                        ‚îÇ :444
         ‚îÇ                             ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   MAIN BACKEND (MT5 Manager API)      ‚îÇ
    ‚îÇ   - FastAPI + Python                  ‚îÇ
    ‚îÇ   - Proxy Copy-PAMM                   ‚îÇ
    ‚îÇ   - MT5 Manager integration           ‚îÇ
    ‚îÇ   https://apekapital.com:444          ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ               ‚îÇ
         ‚îÇ Internal      ‚îÇ MT5Manager
         ‚îÇ :8080         ‚îÇ API
         ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ COPY-   ‚îÇ     ‚îÇ   MT5   ‚îÇ
    ‚îÇ PAMM    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ SERVER  ‚îÇ
    ‚îÇ Backend ‚îÇ     ‚îÇ         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ :5555
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  MT5    ‚îÇ
    ‚îÇ Trade   ‚îÇ
    ‚îÇ Service ‚îÇ
    ‚îÇ  (C#)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ FLUJO DE DATOS RESUMIDO

1. **Frontend/CRM** ‚Üí Llaman a **Main Backend** (p√∫blico)
2. **Main Backend** ‚Üí Conecta directamente con **MT5 Server** via Manager API
3. **Main Backend** ‚Üí Hace proxy a **Copy-PAMM** (interno) para Copy Trading
4. **Copy-PAMM** ‚Üí Llama a **MT5 Trade Service** (interno) para ejecutar trades
5. **MT5 Trade Service** ‚Üí Ejecuta en **MT5 Server** via Manager API
6. **MT5SyncWorker** ‚Üí Sincroniza datos **MT5 ‚Üí Supabase** cada 30-60s
7. Todo usa **Supabase** como base de datos central

---

## ‚úÖ ESTADO DEL SISTEMA

### Funcionalidades operativas:
- ‚úÖ Gesti√≥n de cuentas MT5
- ‚úÖ Balance operations (dep√≥sitos/retiros/bonos)
- ‚úÖ Copy Trading (seguir maestros)
- ‚úÖ Replicaci√≥n autom√°tica de trades
- ‚úÖ Sistema PAMM
- ‚úÖ Sistema de afiliados
- ‚úÖ KYC/Verificaci√≥n
- ‚úÖ CRM administrativo
- ‚úÖ Dashboard real-time con equity

### Puntos de mejora conocidos:
- ‚ö†Ô∏è Copy-PAMM sin dominio p√∫blico (solo interno)
- ‚ö†Ô∏è Configurar dominio para frontend
- ‚ö†Ô∏è Optimizar latencia en replicaci√≥n (actualmente 5s polling)

---

**√öltima actualizaci√≥n:** 2025-10-31
**Versiones:**
- Frontend: 1.0.0
- Main Backend: 1.5.0
- Copy-PAMM: 2.0.0
- MT5 Trade Service: 1.0.0
- CRM: 1.4.2
